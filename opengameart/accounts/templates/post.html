{% extends 'base.html' %}
{% load static %}
{% block title %}Current Posts{% endblock %}

{% block javascript %}
  <script>
    var infinite = new Waypoint.Infinite({
      element: $('.infinite-container')[0],
      onBeforePageLoad: function () {
        $('.loading').show();
      },
      onAfterPageLoad: function ($items) {
        $('.loading').hide();
      }
    });
  </script>
  <script>
    $( "button[class~='like']" ).click(function() {
        let art_id = this.id;
        let art_post_span = $('div.infinite-item').find('span#'+art_id);

        let likes = 0;
        let liked = false;
        let user_id = "{{ user.id }}";
        let url_id = "{% url 'like_post' %}";

        $.get(url_id, {'pk': user_id, 'art_pk': art_id}, function(data){
            likes = data['likes'];
            liked = data['liked'];
            if (liked){
                alert('This post is already liked');
            }
            art_post_span.text(likes);
        });
    });

    $( "button[class~='dislike']" ).click(function() {
        let art_id = this.id;
        let art_post_span = $('div.infinite-item').find('span#'+art_id);

        let likes = 0;
        let disliked = false;
        let user_id = "{{ user.id }}";
        let url_id = "{% url 'dislike_post' %}";

        $.get(url_id, {'pk': user_id, 'art_pk': art_id}, function(data){
            likes = data['likes'];
            disliked = data['disliked'];
            if (disliked){
                alert('This post is already disliked');
            }
            art_post_span.text(likes);
        });
    });
  </script>
{% endblock %}

{% block content %}
    <div class="infinite-container">
        {% if current_user %}
            <a href={% url 'add_art' %}>Add art</a>
        {% endif %}
        {% if posts %}
        {% for post in posts %}
            <div class="infinite-item">
                {% if post.user.user_avatar %}
                    <img src="{{ post.user.user_avatar }}" />
                {% else %}
                    <img src="{% static 'user-default.png' %}" />
                {% endif %}

                <p>{{ post.user.get_username }}</p>
                <p>{{ post.art.title }}</p>
                <img src="{{ post.art.file }}"/>
                <p>Likes: </p><span id="{{ post.art.id }}">{{ post.art.likes }}</span>

                <button id="{{ post.art.id }}" class="btn btn-success like" type="submit" >Like</button>
                <button id="{{ post.art.id }}" class="btn btn-danger dislike" type="submit" >Dislike</button>

                {% if current_user %}
                    <a href={% url 'delete_art' post.art.id %}>Delete art</a>
                {% endif %}
            </div>

        {% endfor %}
        {% else %}
            <p>Sorry, you have no posts</p>
        {% endif %}
    </div>
{% endblock %}